<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Acompanhamento de Checklists</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .card-shadow:hover {
            transform: translateY(-2px);
        }
        .task-detail-list li {
            padding: 4px 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .task-detail-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h1 class="text-3xl font-extrabold text-blue-800 border-b pb-2 mb-4">Painel de Acompanhamento de Limpezas</h1>
            <p class="text-gray-600">Visualiza√ß√£o em tempo real dos Checklists finalizados e enviados.</p>
            <div id="auth-status" class="mt-3 text-sm font-medium text-gray-500">Conectando ao banco de dados...</div>
        </header>

        <!-- Main Content Area: Checklists List -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Checklists Submetidos</h2>
            
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="text-center py-8">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-sky-500 border-t-transparent rounded-full"></div>
                <p class="mt-2 text-gray-500">Carregando dados em tempo real...</p>
            </div>

            <!-- List Container -->
            <div id="checklists-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Data will be injected here -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden text-center py-10 border border-dashed border-gray-300 rounded-lg bg-gray-50">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhum Checklist Encontrado</h3>
                <p class="mt-1 text-sm text-gray-500">Aguardando a primeira submiss√£o...</p>
            </div>
        </div>
    </div>

    <!-- Modal for Full Details -->
    <div id="details-modal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
            <h3 class="text-2xl font-bold text-sky-600 mb-4 border-b pb-2">Detalhes da Submiss√£o</h3>
            <div id="modal-content-details" class="space-y-4">
                <!-- Full data view will be rendered here -->
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="export-single-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-200">
                    Exportar para CSV
                </button>
                <button id="close-modal-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm transition duration-200">
                    Fechar
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug'); // Enable debug logging for Firestore

        // --- GLOBAL FIREBASE VARIABLES ---
        let db;
        let auth;
        let isAuthReady = false;
        let appId = 'default-app-id';
        const SUBMITTED_COLLECTION = 'submittedChecklists';
        let currentChecklistData = null; // Used for single-entry export

        // --- DOM References (Declared globally, assigned in initializeDOMReferences) ---
        let authStatusEl;
        let loadingIndicator;
        let checklistsList;
        let emptyState;
        let detailsModal;
        let modalContentDetails;
        let closeModalBtn;
        let exportSingleBtn;


        // --- Initialization ---
        if (typeof __firebase_config !== 'undefined') {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        }
        if (typeof __app_id !== 'undefined') {
            appId = __app_id;
        }

        /**
         * Inicializa as refer√™ncias DOM e verifica se os elementos cr√≠ticos existem.
         * Colocamos isso dentro de uma fun√ß√£o para garantir que o script seja executado ap√≥s o DOM estar pronto.
         */
        function initializeDOMReferences() {
            // Tentativa de inicializa√ß√£o das refer√™ncias
            authStatusEl = document.getElementById('auth-status');
            loadingIndicator = document.getElementById('loading-indicator');
            checklistsList = document.getElementById('checklists-list');
            emptyState = document.getElementById('empty-state');
            detailsModal = document.getElementById('details-modal');
            modalContentDetails = document.getElementById('modal-content-details');
            closeModalBtn = document.getElementById('close-modal-btn');
            exportSingleBtn = document.getElementById('export-single-btn');

            // VERIFICA√á√ÉO CR√çTICA
            if (!authStatusEl || !checklistsList || !loadingIndicator) {
                const errorMsg = "ERRO CR√çTICO: Falha na inicializa√ß√£o do Painel. Elementos HTML essenciais (Status, Lista) ausentes.";
                console.error(errorMsg, { authStatusEl, checklistsList, loadingIndicator });
                
                // Tenta escrever o erro na √°rea de status
                if (authStatusEl) {
                    authStatusEl.textContent = errorMsg;
                    authStatusEl.className = "text-sm font-medium text-red-600 font-bold";
                }
                return false;
            }
            return true;
        }


        /**
         * Returns the Firestore collection reference for public submitted data.
         */
        function getSubmittedCollectionRef() {
            // Path: /artifacts/{appId}/public/data/submittedChecklists
            return collection(db, 'artifacts', appId, 'public', 'data', SUBMITTED_COLLECTION);
        }

        /**
         * Converte a data ISO string para formato leg√≠vel.
         * @param {string} isoString 
         * @returns {string} Data e hora formatadas
         */
        function formatSubmissionDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        /**
         * Renderiza a lista de checklists.
         * @param {Array<Object>} checklists - Lista de documentos do Firestore.
         */
        function renderChecklists(checklists) {
            loadingIndicator.classList.add('hidden');
            checklistsList.innerHTML = '';

            if (checklists.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            checklists.forEach(doc => {
                const data = doc.data;
                const metadata = data.metadata || {};
                const submissionTime = formatSubmissionDate(data.submittedAt);
                const propertyName = metadata.propriedade || 'Propriedade Sem Nome';
                const cleanerName = metadata.cleaner || 'Cleaner An√¥nimo';

                const cardHtml = `
                    <div id="card-${doc.id}" class="bg-white p-5 rounded-xl card-shadow border border-gray-200 cursor-pointer hover:border-sky-500" data-doc-id="${doc.id}">
                        <p class="text-xs font-semibold text-gray-500 mb-1">Submetido em:</p>
                        <p class="text-sm font-medium text-gray-700 mb-3">${submissionTime}</p>
                        
                        <h3 class="text-xl font-bold text-blue-800 truncate mb-1">${propertyName}</h3>
                        <p class="text-md text-gray-600 mb-4">${cleanerName}</p>
                        
                        <span class="inline-block px-3 py-1 text-xs font-semibold leading-none text-green-800 bg-green-100 rounded-full">FINALIZADO</span>
                    </div>
                `;
                checklistsList.innerHTML += cardHtml;
            });

            // Adiciona listener de clique para os cards
            document.querySelectorAll('[data-doc-id]').forEach(card => {
                card.addEventListener('click', () => {
                    const docId = card.getAttribute('data-doc-id');
                    const checklist = checklists.find(c => c.id === docId);
                    if (checklist) {
                        currentChecklistData = checklist; // Salva para exporta√ß√£o
                        showDetailsModal(checklist.data);
                    }
                });
            });
        }

        /**
         * Exibe o modal com os detalhes completos do checklist.
         * @param {Object} data - Dados completos do checklist submetido.
         */
        function showDetailsModal(data) {
            const metadata = data.metadata || {};
            const tasks = data.tasks || {};
            const submittedAt = formatSubmissionDate(data.submittedAt);

            let html = `
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <p class="text-sm font-semibold text-gray-700">Propriedade: <span class="font-normal text-blue-700">${metadata.propriedade || 'N/A'}</span></p>
                    <p class="text-sm font-semibold text-gray-700">Data do Servi√ßo: <span class="font-normal">${metadata.data || 'N/A'}</span></p>
                    <p class="text-sm font-semibold text-gray-700">Cleaner: <span class="font-normal">${metadata.cleaner || 'N/A'}</span></p>
                    <p class="text-sm font-semibold text-gray-700">Submetido em: <span class="font-normal">${submittedAt}</span></p>
                    <p class="text-xs font-semibold text-gray-500 mt-2 truncate">ID do Usu√°rio (Cleaner): <span class="font-normal">${data.submittedBy || 'N/A'}</span></p>
                </div>
                
                <h4 class="text-lg font-bold text-gray-700 mt-6 mb-3">Tarefas Realizadas (${Object.keys(tasks).length} itens)</h4>
                <ul class="task-detail-list bg-white p-4 rounded-lg border max-h-80 overflow-y-auto">
            `;

            // Reconstroi a estrutura original (usando a estrutura fixa do checklist original como fallback para nomes)
            const checklistStructure = [
                // Estrutura simplificada do checklist original (apenas para obter os nomes das tarefas)
                { id: 'gerais', title: "üè° √ÅREAS COMUNS E GERAIS", tasks: [ "Coletar lixo...", "Limpar espelhos...", "Limpar/Desinfetar interruptores...", "Aspirar/Varrer...", "Desinfetar superf√≠cies...", "Ventilar o ambiente.", "Remover teias..." ] },
                { id: 'sala', title: "üõãÔ∏è SALA DE ESTAR", tasks: [ "Limpar e organizar mesas...", "Limpar a televis√£o...", "Aspirar ou limpar sof√°s...", "Limpar rodap√©s." ] },
                { id: 'quartos', title: "üõèÔ∏è QUARTOS", tasks: [ "Trocar roupas de cama...", "Fazer as camas.", "2 toalhas de banho...", "Sacola de lixo...", "Limpar mesas de cabeceira...", "Limpar espelhos...", "Aspirar ou varrer o ch√£o.", "Limpar dentro do guarda-roupa..." ] },
                { id: 'banheiros', title: "üõÅ BANHEIROS", tasks: [ "Limpar e desinfetar vasos...", "Limpar pias...", "Limpar espelhos.", "Limpar chuveiro...", "Trocar toalhas.", "Limpar o ch√£o.", "Reabastecer papel...", "Sacola de lixo..." ] },
                { id: 'cozinha', title: "üçΩÔ∏è COZINHA", tasks: [ "Limpar a pia.", "Limpar bancadas...", "1 papel toalha...", "No m√≠nimo 5 sacolas...", "Limpar fog√£o e forno...", "Limpar micro-ondas...", "Esvaziar e limpar a geladeira.", "Limpar a lava-lou√ßas...", "Limpar arm√°rios e gavetas...", "Lavar a lou√ßa e guardar.", "Limpar o ch√£o.", "Reabastecer produtos...", "Encher reservat√≥rio de √°gua..." ] },
                { id: 'servico', title: "‚öôÔ∏è √ÅREAS DE SERVI√áO/LAVANDERIA", tasks: [ "Limpar m√°quina de lavar...", "Limpar secadora...", "Limpar tanque/pia...", "Organizar produtos...", "Limpar o ch√£o." ] },
                { id: 'externa', title: "üå≥ VARANDA / √ÅREA EXTERNA", tasks: [ "Varrer ou lavar o ch√£o.", "Limpar m√≥veis...", "Remover teias de aranha.", "Regar plantas...", "Limpar Churrasqueira..." ] },
                { id: 'finalizacao', title: "‚úÖ FINALIZA√á√ÉO", tasks: [ "Verificar se todos os c√¥modos...", "Verificar gavetas e arm√°rios...", "Reabastecer itens de cortesia...", "Repor: 2 √°guas...", "Repor: 2 chocolates...", "Repor: 1 Vinho...", "Ajustar a temperatura...", "Acender luzes...", "Deixar uma nota de boas-vindas...", "Verificar e notificar suprimentos..." ] }
            ];

            // Cria um mapa de ID de tarefa para o nome da tarefa
            const taskMap = {};
            checklistStructure.forEach(section => {
                section.tasks.forEach((taskName, index) => {
                    taskMap[`${section.id}-${index}`] = taskName;
                });
            });

            // Itera sobre as tarefas salvas
            for (const taskId in tasks) {
                const task = tasks[taskId];
                const taskName = taskMap[taskId] || `Tarefa ID: ${taskId}`;
                const status = task.status ? 
                    '<span class="text-green-600 font-bold">FEITO</span>' : 
                    '<span class="text-red-600 font-bold">FALTOU</span>';
                const obs = task.observation ? `<br><span class="text-xs italic text-gray-500">Obs: ${task.observation}</span>` : '';

                html += `
                    <li>
                        <span class="text-gray-900">${taskName}</span>: ${status}
                        ${obs}
                    </li>
                `;
            }

            html += `</ul>`;
            
            modalContentDetails.innerHTML = html;
            detailsModal.classList.remove('hidden');
        }

        /**
         * Exporta os dados de uma √∫nica submiss√£o para CSV.
         * @param {Object} data - Dados completos do checklist submetido.
         */
        function exportToCSV(data) {
            const metadata = data.metadata || {};
            const tasks = data.tasks || {};
            const submittedAt = formatSubmissionDate(data.submittedAt);

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // 1. Metadata
            csvContent += "Metadados\n";
            csvContent += `Propriedade,${metadata.propriedade || ""}\n`;
            csvContent += `Data do Servi√ßo,${metadata.data || ""}\n`;
            csvContent += `Cleaner,${metadata.cleaner || ""}\n`;
            csvContent += `Submetido Em,${submittedAt}\n\n`;

            // 2. Header
            csvContent += `Tarefa,Status,Observa√ß√µes\n`;

            // 3. Task Data
            const checklistStructure = [
                { id: 'gerais', tasks: [ "Coletar lixo...", "Limpar espelhos...", "Limpar/Desinfetar interruptores...", "Aspirar/Varrer...", "Desinfetar superf√≠cies...", "Ventilar o ambiente.", "Remover teias..." ] },
                { id: 'sala', tasks: [ "Limpar e organizar mesas...", "Limpar a televis√£o...", "Aspirar ou limpar sof√°s...", "Limpar rodap√©s." ] },
                { id: 'quartos', tasks: [ "Trocar roupas de cama...", "Fazer as camas.", "2 toalhas de banho...", "Sacola de lixo...", "Limpar mesas de cabeceira...", "Limpar espelhos...", "Aspirar ou varrer o ch√£o.", "Limpar dentro do guarda-roupa..." ] },
                { id: 'banheiros', tasks: [ "Limpar e desinfetar vasos...", "Limpar pias...", "Limpar espelhos.", "Limpar chuveiro...", "Trocar toalhas.", "Limpar o ch√£o.", "Reabastecer papel...", "Sacola de lixo..." ] },
                { id: 'cozinha', tasks: [ "Limpar a pia.", "Limpar bancadas...", "1 papel toalha...", "No m√≠nimo 5 sacolas...", "Limpar fog√£o e forno...", "Limpar micro-ondas...", "Esvaziar e limpar a geladeira.", "Limpar a lava-lou√ßas...", "Limpar arm√°rios e gavetas...", "Lavar a lou√ßa e guardar.", "Limpar o ch√£o.", "Reabastecer produtos...", "Encher reservat√≥rio de √°gua..." ] },
                { id: 'servico', tasks: [ "Limpar m√°quina de lavar...", "Limpar secadora...", "Limpar tanque/pia...", "Organizar produtos...", "Limpar o ch√£o." ] },
                { id: 'externa', tasks: [ "Varrer ou lavar o ch√£o.", "Limpar m√≥veis...", "Remover teias de aranha.", "Regar plantas...", "Limpar Churrasqueira..." ] },
                { id: 'finalizacao', tasks: [ "Verificar se todos os c√¥modos...", "Verificar gavetas e arm√°rios...", "Reabastecer itens de cortesia...", "Repor: 2 √°guas...", "Repor: 2 chocolates...", "Repor: 1 Vinho...", "Ajustar a temperatura...", "Acender luzes...", "Deixar uma nota de boas-vindas...", "Verificar e notificar suprimentos..." ] }
            ];

            const taskMap = {};
            checklistStructure.forEach(section => {
                section.tasks.forEach((taskName, index) => {
                    taskMap[`${section.id}-${index}`] = taskName;
                });
            });

            for (const taskId in tasks) {
                const taskState = tasks[taskId];
                const taskText = taskMap[taskId] || `Tarefa ID: ${taskId}`;
                
                const statusText = taskState && taskState.status ? 'FEITO' : 'FALTOU';
                const observationText = (taskState && taskState.observation ? taskState.observation : "").replace(/"/g, '""');
                
                // Formata a linha
                csvContent += `"${taskText.replace(/[\n\r]/g, ' ').trim()}",` + 
                              `${statusText},` +
                              `"${observationText.replace(/[\n\r]/g, ' ').trim()}"\n`;
            }

            // Cria e dispara o download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            
            const propName = (metadata.propriedade || "Checklist").replace(/[^a-zA-Z0-9]/g, '_');
            const date = (metadata.data || new Date().toISOString().slice(0, 10));
            link.setAttribute("download", `Submissao_Detalhada_${propName}_${date}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Configura a autentica√ß√£o e inicia a escuta de dados.
         */
        async function setupAuthAndListen() {
            if (!auth) {
                authStatusEl.textContent = "ERRO: Firebase Auth n√£o inicializado.";
                authStatusEl.className = "text-sm font-medium text-red-600";
                return;
            }

            try {
                // 1. Autentica√ß√£o
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        authStatusEl.textContent = `Conectado como: ${user.uid}`;
                        authStatusEl.className = "text-sm font-medium text-gray-600 truncate";
                        // 2. Inicia a escuta em tempo real
                        startRealtimeListener();
                    } else {
                        isAuthReady = false;
                        authStatusEl.textContent = "ERRO: Conex√£o com o sistema falhou.";
                        authStatusEl.className = "text-sm font-medium text-red-600";
                        loadingIndicator.classList.add('hidden');
                        emptyState.classList.remove('hidden');
                    }
                });

            } catch (error) {
                console.error("Firebase Auth Error:", error);
                authStatusEl.textContent = `ERRO FATAL: ${error.message}`;
                authStatusEl.className = "text-sm font-medium text-red-600";
            }
        }

        /**
         * Inicia o listener de tempo real do Firestore.
         */
        function startRealtimeListener() {
            if (!db || !isAuthReady) return;

            const q = query(getSubmittedCollectionRef());

            onSnapshot(q, (snapshot) => {
                const checklists = [];
                snapshot.forEach((doc) => {
                    checklists.push({
                        id: doc.id,
                        data: doc.data()
                    });
                });
                // Invertendo a ordem para mostrar os mais recentes primeiro
                checklists.reverse(); 
                renderChecklists(checklists);
            }, (error) => {
                console.error("Erro ao receber dados do Firestore:", error);
                authStatusEl.textContent = `ERRO: Falha na escuta de dados. ${error.message}`;
                authStatusEl.className = "text-sm font-medium text-red-600";
                loadingIndicator.classList.add('hidden');
            });
        }
        
        // --- Event Listeners ---
        closeModalBtn.addEventListener('click', () => {
            detailsModal.classList.add('hidden');
            currentChecklistData = null;
        });

        exportSingleBtn.addEventListener('click', () => {
            if (currentChecklistData) {
                exportToCSV(currentChecklistData.data);
            }
        });

        // Start the application with a try/catch wrapper for safety
        try {
            // Garante que as refer√™ncias DOM existem antes de tentar us√°-las
            if (!initializeDOMReferences()) {
                return; 
            }
            setupAuthAndListen();
        } catch (e) {
            console.error("ERRO FATAL DURANTE O CARREGAMENTO:", e);
            const authStatusEl = document.getElementById('auth-status');
            if (authStatusEl) {
                authStatusEl.textContent = `ERRO FATAL: Falha na inicializa√ß√£o. Verifique o console.`;
                authStatusEl.className = "text-sm font-medium text-red-600";
            }
        }
    </script>
</body>
</html>
